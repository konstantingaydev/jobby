{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Candidate Map</h2>
        <a href="{% url 'recruiter:dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div id="map" style="height: 600px; width: 100%;"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on US
    var map = L.map('map').setView([37.0902, -95.7129], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Create a marker cluster group
    var markers = L.markerClusterGroup();

    // Fetch candidate data
    fetch("{% url 'recruiter:candidate_map_data' %}")
        .then(response => response.json())
        .then(data => {
            data.candidates.forEach(function(c) {
                var marker = L.marker([c.lat, c.lng]);
                
                var popupContent = `
                    <strong>${c.name}</strong><br>
                    <span class="text-muted">${c.headline || 'No headline'}</span><br>
                    <a href="${c.url}" class="btn btn-sm btn-primary mt-2">View Profile</a>
                `;
                
                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            });
            
            map.addLayer(markers);
            
            // Fit bounds if we have markers
            if (data.candidates.length > 0) {
                map.fitBounds(markers.getBounds());
            }
        })
        .catch(error => console.error('Error loading map data:', error));
});
</script>
{% endblock %}