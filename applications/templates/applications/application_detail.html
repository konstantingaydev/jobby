{% extends 'base.html' %}

{% block title %}Application Details - {{ application.job.title }} - Jobby{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'applications:my_applications' %}">My Applications</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ application.job.title }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Application Overview -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Application Details</h4>
                    <span class="badge bg-{{ application.get_status_color|slice:'5:' }} fs-6">
                        {{ application.get_status_display }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-3">{{ application.job.title }}</h5>
                            <p class="mb-2"><strong>Company:</strong> {{ application.job.company_name }}</p>
                            <p class="mb-2"><strong>Location:</strong> {{ application.job.location }}</p>
                            <p class="mb-2"><strong>Employment Type:</strong> {{ application.job.get_employment_type_display }}</p>
                            {% if application.job.salary_range != "Salary not specified" %}
                                <p class="mb-2"><strong>Salary:</strong> {{ application.job.salary_range }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Applied On:</strong> {{ application.applied_at|date:"F d, Y \a\t g:i A" }}</p>
                            <p class="mb-2"><strong>Days Since Applied:</strong> {{ application.days_since_applied }} days</p>
                            <p class="mb-2"><strong>Last Updated:</strong> {{ application.updated_at|date:"F d, Y \a\t g:i A" }}</p>
                            {% if application.viewed_by_recruiter %}
                                <p class="mb-2"><span class="badge bg-success">Viewed by Recruiter</span></p>
                            {% else %}
                                <p class="mb-2"><span class="badge bg-secondary">Not Yet Viewed</span></p>
                            {% endif %}
                        </div>
                    </div>

                    {% if application.cover_note %}
                        <div class="mt-4">
                            <h6>Your Cover Note</h6>
                            <div class="p-3 bg-light rounded">
                                <p class="mb-0">{{ application.cover_note|linebreaks }}</p>
                            </div>
                        </div>
                    {% endif %}

                    <div class="mt-4">
                        <div class="d-flex gap-2">
                            <a href="{% url 'jobs.show' application.job.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-eye"></i> View Job Posting
                            </a>
                            {% if application.can_withdraw %}
                                <a href="{% url 'applications:withdraw_application' application.id %}" class="btn btn-outline-danger">
                                    <i class="fas fa-times"></i> Withdraw Application
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status History -->
            {% if status_history %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Application Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for history in status_history %}
                                <div class="timeline-item mb-3">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <div class="timeline-marker bg-{{ history.new_status|yesno:'primary,warning,info,success,secondary' }}"></div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-1">Status changed to {{ history.get_new_status_display }}</h6>
                                                <small class="text-muted">{{ history.changed_at|date:"M d, Y g:i A" }}</small>
                                            </div>
                                            <p class="text-muted mb-1">Changed by: {{ history.changed_by.get_full_name|default:history.changed_by.username }}</p>
                                            {% if history.notes %}
                                                <p class="small mb-0">{{ history.notes }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            <!-- Initial application -->
                            <div class="timeline-item">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <div class="timeline-marker bg-primary"></div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="mb-1">Application Submitted</h6>
                                            <small class="text-muted">{{ application.applied_at|date:"M d, Y g:i A" }}</small>
                                        </div>
                                        <p class="text-muted mb-0">You applied to this position</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Status Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Application Progress</h5>
                </div>
                <div class="card-body">
                    <div class="progress-steps">
                        <div class="step {% if application.status == 'applied' %}active{% elif application.status != 'applied' %}completed{% endif %}">
                            <div class="step-icon">1</div>
                            <div class="step-label">Applied</div>
                        </div>
                        <div class="step {% if application.status == 'review' %}active{% elif application.status in 'interview,offer,closed' %}completed{% endif %}">
                            <div class="step-icon">2</div>
                            <div class="step-label">Under Review</div>
                        </div>
                        <div class="step {% if application.status == 'interview' %}active{% elif application.status in 'offer,closed' %}completed{% endif %}">
                            <div class="step-icon">3</div>
                            <div class="step-label">Interview</div>
                        </div>
                        <div class="step {% if application.status == 'offer' %}active{% elif application.status == 'closed' %}completed{% endif %}">
                            <div class="step-icon">4</div>
                            <div class="step-label">Offer</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Quick Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Job Information</h5>
                </div>
                <div class="card-body">
                    {% if application.job.is_remote %}
                        <span class="badge bg-success mb-2">Remote</span>
                    {% endif %}
                    {% if application.job.visa_sponsorship %}
                        <span class="badge bg-info mb-2">Visa Sponsorship</span>
                    {% endif %}
                    
                    {% if application.job.skills_required %}
                        <h6 class="mt-3">Required Skills</h6>
                        <div>
                            {% for skill in application.job.skills_list %}
                                <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <small class="text-muted">Posted by: {{ application.job.posted_by.get_full_name|default:application.job.posted_by.username }}</small><br>
                        <small class="text-muted">Posted on: {{ application.job.created_at|date:"M d, Y" }}</small>
                    </div>
                </div>
            </div>

            <!-- Tips -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Next Steps</h5>
                </div>
                <div class="card-body">
                    {% if application.status == 'applied' %}
                        <p class="small">Your application has been submitted. The recruiter will review it soon.</p>
                    {% elif application.status == 'review' %}
                        <p class="small">Great! Your application is being reviewed. You may be contacted for next steps.</p>
                    {% elif application.status == 'interview' %}
                        <p class="small">Congratulations! You've been selected for an interview. Prepare well and good luck!</p>
                    {% elif application.status == 'offer' %}
                        <p class="small">Excellent! You've received an offer. Take time to review the terms carefully.</p>
                    {% elif application.status == 'closed' %}
                        <p class="small">This application has been closed. Keep applying to other opportunities!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-top: 4px;
}

.progress-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.step {
    display: flex;
    align-items: center;
    opacity: 0.5;
}

.step.active,
.step.completed {
    opacity: 1;
}

.step-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    margin-right: 10px;
}

.step.active .step-icon {
    background-color: #0d6efd;
}

.step.completed .step-icon {
    background-color: #198754;
}

.step-label {
    font-weight: 500;
}
</style>
{% endblock %}
