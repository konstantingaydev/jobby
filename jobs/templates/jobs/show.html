{% extends 'base.html' %}
{% block content %}
{% load static %}
{% if not template_data.job.is_remote and template_data.job.latitude and template_data.job.longitude %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
{% endif %}
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'jobs.index' %}">Jobs</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ template_data.job.title }}</li>
          </ol>
        </nav>
      </div>
    </div>
    
    <div class="row">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h1 class="card-title mb-1">{{ template_data.job.title }}</h1>
                <h4 class="text-muted mb-3">{{ template_data.job.company_name }}</h4>
              </div>
              {% if user.is_authenticated and user == template_data.job.posted_by %}
                <div class="btn-group">
                  <a href="{% url 'recommendations:job_recommendations' template_data.job.id %}" class="btn btn-warning btn-sm">
                    <i class="fas fa-user-check"></i> Recommendations
                  </a>
                  <a href="{% url 'jobs.edit' id=template_data.job.id %}" class="btn btn-outline-primary btn-sm">Edit</a>
                  <a href="{% url 'jobs.delete' id=template_data.job.id %}" class="btn btn-outline-danger btn-sm">Delete</a>
                </div>
              {% endif %}
            </div>
            
            <div class="row mb-4">
              <div class="col-md-6">
                <p class="mb-2">
                  <i class="fas fa-map-marker-alt text-primary"></i>
                  <strong>Location:</strong> {{ template_data.job.location }}
                  {% if template_data.job.is_remote %}
                    <span class="badge bg-success ms-1">Remote</span>
                  {% endif %}
                </p>
                <p class="mb-2">
                  <i class="fas fa-briefcase text-primary"></i>
                  <strong>Type:</strong> {{ template_data.job.get_employment_type_display }}
                </p>
              </div>
              <div class="col-md-6">
                <p class="mb-2">
                  <i class="fas fa-chart-line text-primary"></i>
                  <strong>Level:</strong> {{ template_data.job.get_experience_level_display }}
                </p>
                <p class="mb-2">
                  <i class="fas fa-dollar-sign text-primary"></i>
                  <strong>Salary:</strong> {{ template_data.job.salary_range }}
                </p>
              </div>
            </div>
            
            {% if not template_data.job.is_remote and template_data.job.latitude and template_data.job.longitude %}
            <div class="mb-4">
              <h5 class="mb-3">Job Location</h5>
              <p class="text-muted mb-2">
                <i class="fas fa-map-marker-alt"></i> {{ template_data.job.location }}
              </p>
              <div id="job-location-map" style="height: 450px; border: 1px solid #ddd; border-radius: 0.375rem;"></div>
            </div>
            {% endif %}
            
            <div class="mb-4">
              <h5>Job Description</h5>
              <p class="text-muted">{{ template_data.job.description|linebreaks }}</p>
            </div>
            
            <div class="mb-4">
              <h5>Requirements</h5>
              <p class="text-muted">{{ template_data.job.requirements|linebreaks }}</p>
            </div>
            
            {% if template_data.job.benefits %}
            <div class="mb-4">
              <h5>Benefits & Perks</h5>
              <p class="text-muted">{{ template_data.job.benefits|linebreaks }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body text-center">
            {% if template_data.job.image %}
              <img src="{{ template_data.job.image.url }}" class="img-fluid rounded mb-3" style="max-height: 200px;">
            {% else %}
              <div class="bg-light rounded mb-3 d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-building fa-3x text-muted"></i>
              </div>
            {% endif %}
            
            <h5>{{ template_data.job.company_name }}</h5>
            <p class="text-muted mb-3">Posted by {{ template_data.job.posted_by.get_full_name|default:template_data.job.posted_by.username }}</p>
            
            <div class="d-grid gap-2">
              {% if user.is_authenticated %}
                {% if user.profile.user_type == 'regular' %}
                  {% if not user_application %}
                    <!-- Quick Apply Button -->
                    <button id="quick-apply-btn" class="btn btn-primary btn-lg" data-job-id="{{ template_data.job.id }}">
                      <i class="fas fa-paper-plane"></i> Quick Apply
                    </button>
                    <!-- Apply with Note Button -->
                    <a href="{% url 'applications:apply_with_note' template_data.job.id %}" class="btn btn-outline-primary">
                      <i class="fas fa-edit"></i> Apply with Note
                    </a>
                  {% else %}
                    <!-- Already Applied -->
                    <div class="alert alert-info mb-2">
                      <i class="fas fa-check-circle"></i> You have applied to this job
                      <br><small>Status: <strong>{{ user_application.get_status_display }}</strong></small>
                    </div>
                    <a href="{% url 'applications:application_detail' user_application.id %}" class="btn btn-outline-primary">
                      <i class="fas fa-eye"></i> View Application
                    </a>
                  {% endif %}
                {% else %}
                  <div class="alert alert-warning">
                    <small>Only job seekers can apply to jobs</small>
                  </div>
                {% endif %}
              {% else %}
                <a href="{% url 'accounts.login' %}" class="btn btn-primary btn-lg">
                  <i class="fas fa-sign-in-alt"></i> Login to Apply
                </a>
              {% endif %}
              <button class="btn btn-outline-secondary">Save Job</button>
            </div>
            
            <hr>
            <small class="text-muted">
              <i class="fas fa-clock"></i> Posted {{ template_data.job.created_at|timesince }} ago<br>
              <i class="fas fa-edit"></i> Updated {{ template_data.job.updated_at|timesince }} ago
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
{% if not template_data.job.is_remote and template_data.job.latitude and template_data.job.longitude %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
(async function() {
  console.log('Job location map script starting');
  try {
    if (typeof L === 'undefined') {
      console.warn('Leaflet (L) is undefined - attempting fallback load');
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        s.crossOrigin = 'anonymous';
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      }).catch(() => {});
      if (typeof L === 'undefined') {
        console.error('Leaflet (L) is still undefined after fallback');
        return;
      }
    }
  } catch(e) {
    console.error('Error checking/loading Leaflet', e);
  }

  const lat = parseFloat('{{ template_data.job.latitude }}');
  const lon = parseFloat('{{ template_data.job.longitude }}');
  
  if (isNaN(lat) || isNaN(lon)) {
    console.error('Invalid coordinates:', lat, lon);
    return;
  }

  try {
    const map = L.map('job-location-map').setView([lat, lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([lat, lon]).addTo(map);
    const popupContent = '<b>' + escapeHtml('{{ template_data.job.title|escapejs }}') + '</b><br>' + 
                        escapeHtml('{{ template_data.job.company_name|escapejs }}') + '<br>' + 
                        escapeHtml('{{ template_data.job.location|escapejs }}');
    marker.bindPopup(popupContent).openPopup();

    console.log('Job location map initialized successfully');
  } catch(e) {
    console.error('Error initializing job location map', e);
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
})();
</script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const quickApplyBtn = document.getElementById('quick-apply-btn');
    
    if (quickApplyBtn) {
        quickApplyBtn.addEventListener('click', function() {
            const jobId = this.getAttribute('data-job-id');
            const btn = this;
            
            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
            
            // Make AJAX request
            fetch(`/applications/quick-apply/${jobId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    btn.innerHTML = '<i class="fas fa-check"></i> Applied Successfully!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    
                    // Show success alert
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success mt-2';
                    alertDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;
                    btn.parentNode.insertBefore(alertDiv, btn.nextSibling);
                    
                    // Redirect to applications page after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/applications/my-applications/';
                    }, 2000);
                } else {
                    // Show error message
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Quick Apply';
                    
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger mt-2';
                    alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message}`;
                    btn.parentNode.insertBefore(alertDiv, btn.nextSibling);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Quick Apply';
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger mt-2';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> An error occurred. Please try again.';
                btn.parentNode.insertBefore(alertDiv, btn.nextSibling);
            });
        });
    }
});
</script>
{% endblock %}
